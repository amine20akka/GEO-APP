<div class="fixed bottom-0 top-0 w-full sm:w-96 lg:sticky lg:left-full lg:h-screen lg:w-16 lg:shadow">
    <div class="bg-card flex h-full w-full flex-col transition-transform duration-400 ease-drawer sm:w-96" [ngClass]="{
            '-translate-x-full shadow sm:-translate-x-96 lg:-translate-x-80':
                opened,
            'translate-x-0': !opened,
        }">
        <!-- Header -->
        <div class="quick-chat-header flex flex-0 cursor-pointer items-center justify-start" (click)="toggle()">
            <!-- Toggle -->
            @if (!opened || (opened && !selectedLayer)) {
            <div class="flex flex-auto items-center justify-center">
                <div class="flex w-16 flex-0 items-center justify-center">
                    <mat-icon [matTooltip]="tooltip || 'Couches'" class="icon-size-6" [svgIcon]="
                                'heroicons_outline:square-3-stack-3d'
                            "></mat-icon>
                </div>
                <div class="text-secondary text-lg font-medium">
                    Couches
                </div>
                <button class="ml-auto mr-4" mat-icon-button>
                    <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                </button>
            </div>
            }

            <!-- layer info -->
            @if (opened && selectedLayer) {
            <div class="ml-3 flex flex-auto items-center">
                <div class="relative flex h-10 w-10 flex-0 items-center justify-center">

                    <div
                        class="flex h-full w-full items-center justify-center rounded-full bg-gray-200 text-lg uppercase text-gray-600 dark:bg-gray-700 dark:text-gray-200">
                        {{ selectedLayer.name.charAt(0) }}
                    </div>

                </div>
                <div class="ml-4 truncate text-lg font-medium leading-5">
                    {{ formatLayerName(selectedLayer.name) }}
                </div>
                <button class="ml-auto mr-4" mat-icon-button>
                    <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                </button>
            </div>
            }
        </div>

        <!-- Content -->
        <div class="flex flex-auto overflow-hidden border-t">
            <!-- layers list -->
            <div class="h-full w-16 flex-0 overflow-y-auto overscroll-y-contain sm:overflow-hidden sm:overscroll-auto"
                fuseScrollbar [fuseScrollbarOptions]="{ wheelPropagation: false }">
                <div class="flex-auto">
                    <!-- Couches GeoServer -->
                    <div class="mb-2">
                        <h3
                            class="text-xs mb-2 py-1 text-center font-semibold tracking-wider text-gray-500 border-b border-gray-200">
                            Couches publiées
                        </h3>
                        @for (layer of layers | filterLayers:'WFS':'WMS'; track trackByFn($index, layer); let i =
                        $index) {
                        <div class="relative" [attr.data-index]="i">
                            <div class="h-1 w-full transition-all duration-200 ease-in-out"
                                [ngClass]="{'bg-blue-200 h-2': draggedOverIndex === i}">
                            </div>
                            <div class="flex justify-center cursor-pointer items-center px-3 py-2 transition-all duration-200 ease-in-out layer-item hover:w-auto"
                                [ngClass]="{
               'hover:bg-gray-100 dark:hover:bg-gray-700': !selectedLayer || selectedLayer !== layer,
               'bg-primary-50 dark:bg-gray-600': selectedLayer && selectedLayer === layer,
               'opacity-50': draggedIndex === i
             }" (dragstart)="onDragStart($event, i)" (dragend)="onDragEnd($event)" (dragover)="onDragOver($event, i)"
                                (dragleave)="onDragLeave()" (drop)="onDrop($event, i)" (click)="selectedLayer = layer"
                                draggable="true" (click)="onLayerVisibilityChange(layer.id)">
                                <div [matTooltip]="layer.name || 'Cliquer pour visualiser'"
                                    class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-xs uppercase text-gray-600 dark:bg-gray-700 dark:text-gray-200 shadow-sm layer-name overflow-hidden text-ellipsis whitespace-nowrap">
                                    {{ formatLayerName(layer.name).substring(0, 3) }}
                                </div>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Couches importées -->
                    <div class="mt-4">
                        <h3
                            class="text-xs mb-2 py-1 text-center font-semibold tracking-wider text-gray-500 border-b border-t border-gray-200">
                            Couches importées
                        </h3>
                        @if ((layers | filterLayers:'IMPORT').length > 0) {
                        @for (layer of layers | filterLayers:'IMPORT'; track trackByFn($index, layer); let i = $index) {
                        <div class="relative" [attr.data-index]="i">
                            <div class="h-1 w-full transition-all duration-200 ease-in-out"
                                [ngClass]="{'bg-blue-200 h-2': draggedOverIndex === i}">
                            </div>
                            <div class="flex justify-center cursor-pointer items-center px-3 py-2 transition-all duration-200 ease-in-out layer-item hover:w-auto"
                                [ngClass]="{
               'hover:bg-gray-100 dark:hover:bg-gray-700': !selectedLayer || selectedLayer !== layer,
               'bg-primary-50 dark:bg-gray-600': selectedLayer && selectedLayer === layer,
               'opacity-50': draggedIndex === i
             }" (dragstart)="onDragStart($event, i)" (dragend)="onDragEnd($event)" (dragover)="onDragOver($event, i)"
                                (dragleave)="onDragLeave()" (drop)="onDrop($event, i)" (click)="selectedLayer = layer"
                                draggable="true" (click)="onLayerVisibilityChange(layer.id)">
                                <div [matTooltip]="layer.name || 'Cliquer pour visualiser'"
                                    class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-200 text-xs uppercase text-gray-600 dark:bg-gray-700 dark:text-gray-200 shadow-sm layer-name overflow-hidden text-ellipsis whitespace-nowrap">
                                    {{ formatLayerName(layer.name).substring(0, 3) }}
                                </div>

                            </div>
                        </div>
                        }
                        } @else {
                        <div class="flex flex-col justify-center items-center pb-3">
                            <p class="text-xs justify-center items-center text-center py-2">Importer ici :</p>
                            <button class="flex rounded-full bg-blue-100" mat-icon-button (click)="openFileInput()"
                                [matTooltip]="'Importer une couche'">
                                <mat-icon [svgIcon]="'heroicons_outline:arrow-down-tray'"></mat-icon>
                            </button>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- layer management -->
            <div class="flex flex-auto flex-col overflow-hidden border-l bg-card">
                @if (selectedLayer) {
                <!-- <mat-card class="m-4">
                    <mat-card-header>
                      <mat-card-title class="font-bold">{{ selectedLayer.name }}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      
                    </mat-card-content>
                  </mat-card> -->

                <mat-card class="m-4">
                    <mat-card-header>
                        <mat-card-title class="font-bold" *ngIf="selectedLayer">        
                             {{ selectedLayer.name }}: {{ getGeometryType(selectedLayer) }}
                        </mat-card-title>
                        <mat-card-title class="font-bold" *ngIf="!selectedLayer">
                             No layer selected
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        
                        <mat-expansion-panel>
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    Details
                                </mat-panel-title>
                                <mat-panel-description>
                                    <mat-icon>expand_more</mat-icon>
                                </mat-panel-description>
                            </mat-expansion-panel-header>
                            <mat-list>
                                <mat-list-item>
                                    <span matListItemTitle>Type</span>
                                    <span matListItemLine>{{ selectedLayer.type }}</span>
                                </mat-list-item>
                                <mat-list-item>
                                    <span matListItemTitle>Source</span>
                                    <span matListItemLine>{{ selectedLayer.source }}</span>
                                </mat-list-item>
                               


                                
                            </mat-list>
                        </mat-expansion-panel>

                        <div id="mini-map" style="width: 100%; height: 200px; margin-top: 20px; border: 1px solid #ccc;"></div>



                    </mat-card-content>
                </mat-card>

                <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="m-4" animationDuration="0ms">
                    <mat-tab label="Color">
                        <ng-template matTabContent>
                            <div class="p-4">
                                <app-color-pie-chart [selectedColor]="getLayerColor()"
                                    (colorChange)="updateLayerColor($event)">
                                </app-color-pie-chart>
                                <div class="flex items-center mt-4">
                                    <mat-form-field class="flex-grow">
                                        <mat-label>Initial Color</mat-label>
                                        <input matInput [value]="getSelectedLayerColor()" readonly>
                                    </mat-form-field>
                                    <button mat-icon-button color="primary" (click)="resetToInitialColor()" matTooltip="Reset to initial color">
                                        <mat-icon>refresh</mat-icon>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4" *ngIf="getGeometryType(selectedLayer) !== 'LineString' && getGeometryType(selectedLayer) !== 'MultiLineString'">
                                <app-color-pie-chart [selectedColor]="getLayerStrokeColor()"
                                                     (colorChange)="updateLayerStrokeColor($event)">
                                </app-color-pie-chart>
                                <div class="flex items-center mt-4">
                                    <mat-form-field class="flex-grow">
                                        <mat-label>Initial Stroke Color</mat-label>
                                        <input matInput [value]="getLayerStrokeInColor()" readonly>
                                    </mat-form-field>
                                    <button mat-icon-button color="primary" (click)="resetToInitialStrokeColor()" matTooltip="Reset to initial stroke color">
                                        <mat-icon>refresh</mat-icon>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4">
                                <mat-slider class="w-full" color="primary" [min]="0" [max]="10" [step]="0.1"
                                    [discrete]="true">
                                    <input matSliderThumb [value]="getLayerStrokeWidth()"
                                        (input)="updateLayerStrokeWidth($event.target.value)">
                                </mat-slider>
                                <mat-form-field class="w-full mt-4">
                                    <mat-label>Stroke Width</mat-label>
                                    <input matInput type="number" min="0" max="10" step="0.1"
                                        [ngModel]="getLayerStrokeWidth()"
                                        (ngModelChange)="updateLayerStrokeWidth($event)"
                                        placeholder="Enter stroke width (0-10)">
                                </mat-form-field>
                            </div>
                        </ng-template>
                    </mat-tab>

                    <mat-tab label="Opacity">
                        <ng-template matTabContent>
                            <div class="p-4">
                                <mat-slider class="w-full" color="primary" [min]="0" [max]="1" [step]="0.01"
                                    [discrete]="true">
                                    <input matSliderThumb [value]="selectedLayer?.layer?.getOpacity() ?? 1"
                                        (input)="updateLayerOpacity($event)">
                                </mat-slider>
                                <mat-form-field class="w-full mt-4">
                                    <mat-label>Opacity</mat-label>
                                    <input matInput type="number" min="0" max="1" step="0.01"
                                        [ngModel]="selectedLayer?.layer?.getOpacity() ?? 1"
                                        (ngModelChange)="updateLayerOpacity($event)" placeholder="Enter opacity (0-1)">
                                </mat-form-field>
                            </div>
                        </ng-template>
                    </mat-tab>



                    
                    <mat-tab label="Symbologie" *ngIf="getGeometryType(selectedLayer) === 'Point' || getGeometryType(selectedLayer) === 'MultiPoint'">
                        <ng-template matTabContent>
                            <div class="p-4">
                                <h3>Point Symbol</h3>
                                <mat-form-field class="w-full">
                                    <mat-label>Select Symbol</mat-label>
                                    <mat-select [(value)]="selectedSymbol" (selectionChange)="updateLayerSymbol()">
                                        <mat-select-trigger>
                                            <mat-icon>{{getSelectedSymbolIcon()}}</mat-icon>
                                            {{getSelectedSymbolLabel()}}
                                        </mat-select-trigger>
                                        <mat-option *ngFor="let symbol of availableSymbols" [value]="symbol.value">
                                            <mat-icon>{{symbol.icon}}</mat-icon>
                                            {{symbol.label}}
                                        </mat-option>

                                    </mat-select>
                                </mat-form-field>

                                <h3 class="mt-4">Symbol Size</h3>
                                <mat-slider class="w-full" min="1" max="100" step="1">
                                    <input matSliderThumb [(ngModel)]="symbolSize"
                                        (ngModelChange)="updateLayerSymbol()">

                                </mat-slider>

                                <mat-form-field class="w-full mt-2">
                                    <mat-label>Symbol Size</mat-label>
                                    <input matInput type="number" [(ngModel)]="symbolSize"
                                        (ngModelChange)="updateLayerSymbol()" min="12" max="48">
                                </mat-form-field>

                                <h3 class="mt-4">Symbol Color</h3>
                                <mat-form-field class="w-full">
                                    <mat-label>Symbol Color</mat-label>
                                    <input matInput type="color" [(ngModel)]="symbolColor"
                                        (ngModelChange)="updateLayerSymbol()">
                                </mat-form-field>

                                <h3 class="mt-4">Opacity</h3>
                                <mat-slider class="w-full" min="0" max="1" step="0.1">
                                    <input matSliderThumb [(ngModel)]="symbolOpacity"
                                        (ngModelChange)="updateLayerSymbol()">
                                </mat-slider>

                                <mat-form-field class="w-full mt-2">
                                    <mat-label>Opacity</mat-label>
                                    <input matInput type="number" [(ngModel)]="symbolOpacity"
                                        (ngModelChange)="updateLayerSymbol()" min="0" max="1" step="0.1">
                                </mat-form-field>
                            </div>
                        </ng-template>
                    </mat-tab>

                    

                </mat-tab-group>
                } @else {
                <div class="flex h-full w-full flex-auto flex-col items-center justify-center p-4">
                    <mat-icon class="text-6xl text-hint" svgIcon="layers"></mat-icon>
                    <h2 class="mt-4 text-center text-2xl font-medium text-secondary">Select a Layer</h2>
                    <p class="mt-2 text-center text-hint">Choose a layer from the list to view and edit its properties
                    </p>
                </div>
                }
            </div>
        </div>
    </div>
</div>